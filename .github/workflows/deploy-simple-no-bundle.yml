name: Deploy Simple (No Bundle)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy exactly like local
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.LIGHTSAIL_HOST }}
        username: ${{ secrets.LIGHTSAIL_USER }}
        key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
        script: |
          echo "=== Deploy simple como en local ==="
          
          cd /home/ubuntu/billeo-app
          
          # Limpiar estado anterior
          pm2 stop all || true
          pm2 delete all || true
          
          # Actualizar código
          git stash || true
          git pull origin main
          
          # Instalar dependencias (TODAS, como en local)
          npm install
          
          # Crear directorios
          mkdir -p uploads logs
          
          # BUILD DEL FRONTEND (para producción)
          echo -e "\n🏗️ Construyendo frontend:"
          npx vite build --outDir server/public
          
          # Verificar que npm start está definido
          echo "📋 Scripts disponibles:"
          npm run --silent | grep -E "(start|dev)" || echo "No hay script start/dev"
          
          # Iniciar exactamente como en local pero en puerto 5000
          echo -e "\n🚀 Iniciando como en local:"
          PORT=5000 NODE_ENV=production pm2 start "npm start" --name billeo-app
          
          # Verificar
          sleep 5
          pm2 status
          pm2 logs billeo-app --lines 10 --nostream || echo "Sin logs"
          
          # Probar
          echo -e "\n🔍 Pruebas:"
          curl -I http://localhost:5000 2>/dev/null && echo "✅ Puerto 5000 OK" || echo "❌ Puerto 5000 falla"
          curl -I http://localhost:80 2>/dev/null && echo "✅ Nginx OK" || echo "❌ Nginx falla"
          
          pm2 save
          echo -e "\n✅ Deploy simple completado" 