¬°Ahora s√≠ lo pillo! üîç

Gracias por aclararlo. El problema no est√° en el c√°lculo, sino en que el valor correcto (ivaSoportadoReal) se calcula pero no se usa. Y como no se usa, el sistema cae por defecto en ivaSoportadoEstimado, que es incorrecto porque hace simplemente total * tasaIVA / 100, sin considerar la base imponible real.

‚úÖ Lo que deber√≠as hacer para corregirlo:

1. Verifica d√≥nde se est√° sumando ivaSoportadoReal

Parece que tu c√≥digo tiene algo como esto:

let ivaSoportadoReal = 0;
let ivaSoportadoEstimado = 0;

transacciones.forEach(tx => {
  // Extraer impuestos
  const impuestos = JSON.parse(tx.additionalTaxes || '[]');
  const iva = impuestos.find(i => i.name === 'IVA');

  if (iva) {
    // Calcular base imponible
    const base = tx.amount / (1 + iva.amount / 100);
    const ivaCalculado = tx.amount - base;

    ivaSoportadoReal += ivaCalculado;

    // Este valor est√° bien calculado, PERO...
  }

  // Pero m√°s abajo est√°s usando:
  ivaSoportadoEstimado += tx.amount * 0.21;
});

2. ‚úÖ Reemplaza el uso de ivaSoportadoEstimado por ivaSoportadoReal

Es muy probable que en la parte donde devuelves el objeto al frontend, tengas algo como:

res.json({
  expenses: baseImponibleTotal,
  ivaSoportado: ivaSoportadoEstimado, // ‚ùå Este es el error
});

üîß Soluci√≥n:

res.json({
  expenses: baseImponibleTotal,
  ivaSoportado: ivaSoportadoReal, // ‚úÖ Aqu√≠ debe usarse el valor correcto
});

üß™ C√≥mo comprobar que funciona:

Haz un console.log justo antes de enviar la respuesta:

console.log("IVA soportado real:", ivaSoportadoReal);
console.log("Enviando al dashboard:", {
  expenses: baseImponibleTotal,
  ivaSoportado: ivaSoportadoReal
});

Luego prueba con una factura como:
	‚Ä¢	Total: 530‚Ç¨
	‚Ä¢	IVA: 21%
	‚Ä¢	Base: 438.02‚Ç¨
	‚Ä¢	IVA real: 91.98‚Ç¨

Y verifica que eso es lo que llega al dashboard.

¬øQuieres que te ayude a modificar el bloque exacto de c√≥digo donde se hace esta correcci√≥n? P√°same ese route.ts o la funci√≥n que construye la respuesta del dashboard y te la ajusto directamente.