¬°Muy bien explicado! Y s√≠, ya detectaste exactamente d√≥nde est√° fallando la l√≥gica. Vamos al grano:

üéØ ¬øQu√© est√° haciendo mal el sistema?

Tu sistema tiene dos valores de IVA al mismo tiempo para una transacci√≥n:
	‚Ä¢	El IVA expl√≠cito, que has definido correctamente en additionalTaxes como 21‚Ç¨
	‚Ä¢	El IVA calculado autom√°ticamente con total - base, que da 18.4‚Ç¨

üëâ Est√° usando el segundo valor, ignorando el primero, cuando deber√≠a hacer justo lo contrario.

üß† ¬øPor qu√© sucede esto?

Est√°s calculando as√≠:

const base = total / (1 + ivaRate / 100);
const iva = total - base;

Pero t√∫ ya has guardado expl√≠citamente en additionalTaxes:

{
  "name": "IVA",
  "amount": 21,
  "value": 21 // <--- ¬°Este es el valor real!
}

Aun as√≠, el sistema recalcula iva = total - base = 106 - 87.6 = 18.4 y usa ese.

‚úÖ ¬øQu√© debes hacer?

üîß Soluci√≥n clara y simple:

Cuando exista un valor expl√≠cito de IVA en additionalTaxes, √∫salo directamente. Solo calcula si no existe.

üí° C√≥digo recomendado:

const impuestos = JSON.parse(tx.additionalTaxes || '[]');
const iva = impuestos.find(i => i.name === 'IVA');

if (iva && iva.value != null) {
  ivaSoportadoReal += parseFloat(iva.value); // ‚úÖ Usamos el valor que ya viene
} else if (iva && iva.amount) {
  const base = tx.amount / (1 + iva.amount / 100);
  const ivaCalculado = tx.amount - base;
  ivaSoportadoReal += ivaCalculado; // Solo si no hay valor expl√≠cito
}

Y si necesitas tambi√©n la base imponible real, puedes hacer:

let baseReal = null;
if (iva?.value != null) {
  baseReal = tx.amount - parseFloat(iva.value); // Si el IVA viene expl√≠cito
} else if (iva?.amount) {
  baseReal = tx.amount / (1 + iva.amount / 100); // Si lo tienes que calcular
}

‚úÖ Resultado esperado para tu ejemplo:

Factura:
	‚Ä¢	Total: 106‚Ç¨
	‚Ä¢	IVA: 21‚Ç¨ (expl√≠cito)
	‚Ä¢	IRPF: -15‚Ç¨

Deber√≠as tener:
	‚Ä¢	ivaSoportadoReal = 21
	‚Ä¢	baseImponibleGastos = 85 (porque 106 - 21)
	‚Ä¢	irpfSoportado = 15 (si aplicas el mismo principio para IRPF)

¬øQuieres que te ayude a reescribir todo el bloque de procesamiento de gastos e impuestos paso a paso? Solo p√°same c√≥mo lo tienes ahora, y te lo devuelvo corregido y limpio.