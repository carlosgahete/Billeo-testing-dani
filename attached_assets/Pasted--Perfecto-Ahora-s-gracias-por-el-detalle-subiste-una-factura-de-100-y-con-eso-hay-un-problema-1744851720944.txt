Â¡Perfecto! Ahora sÃ­, gracias por el detalle: subiste una factura de 100â€¯â‚¬, y con eso hay un problema en cÃ³mo se estÃ¡n interpretando los valores. Vamos a desglosarlo paso a paso para identificar exactamente quÃ© falla.

ğŸ§¾ Supuesto correcto de la factura subida

La factura subida tiene estos valores:
	â€¢	Base imponible: 100â€¯â‚¬
	â€¢	IVA 21%: 21â€¯â‚¬
	â€¢	IRPF -15%: -15â€¯â‚¬
	â€¢	Total factura:
	â€¢	Si la retenciÃ³n de IRPF no afecta el total, el total bruto es 121â€¯â‚¬
	â€¢	Si el IRPF se descuenta, el total neto a pagar serÃ­a 106â€¯â‚¬

	Necesitamos aclarar quÃ© se guarda como totalAmount: Â¿es el bruto con IVA o el neto con IVA - IRPF?

Pero vamos con ambas posibilidades:

ğŸ§  POSIBILIDAD 1: El total es 121â€¯â‚¬

(Es decir: 100 base + 21 IVA)

Entonces:
	â€¢	baseAmount: 100â€¯â‚¬
	â€¢	ivaAmount: 21â€¯â‚¬
	â€¢	irpfAmount: -15â€¯â‚¬
	â€¢	totalAmount: 121â€¯â‚¬

Esto es contablemente correcto.
Y el cÃ¡lculo esperado serÃ­a:

expenses = 100
ivaSoportado = 21
netExpenses = 106 // 121 - 15

Si el sistema sÃ³lo ve el totalAmount (121) y calcula la base como 121 / 1.21 â‰ˆ 100, Â¡bien!

Pero si por error recalcula el IVA como 121 - base â‰ˆ 21, y luego vuelve a restar IVA (en vez de IRPF)â€¦ ahÃ­ hay lÃ­o.

ğŸ§  POSIBILIDAD 2: El total es 106â€¯â‚¬

(Es decir: 100 base + 21 IVA - 15 IRPF = 106)

	Este suele ser el caso mÃ¡s comÃºn cuando el IRPF se descuenta en origen (en vez de pagarse aparte).

Entonces:
	â€¢	baseAmount: 100
	â€¢	ivaAmount: 21
	â€¢	irpfAmount: -15
	â€¢	totalAmount: 106

AquÃ­ es donde muchos sistemas fallan.

Si el backend hace esto:

// calcula base desde total
base = 106 / 1.21 â‰ˆ 87.6
iva = 106 - base â‰ˆ 18.4

ğŸš¨ Â¡ERROR! Porque ya tienes el valor correcto del IVA: 21â€¯â‚¬, y el total tiene aplicada la retenciÃ³n.

ğŸ” Â¿DÃ³nde puede estar fallando tu sistema?

âŒ ERROR 1: Ignorar el IVA explÃ­cito

Si a pesar de tener ivaAmount: 21, el sistema lo recalcula como total - base, darÃ¡ mal (ej. 18.4)

âŒ ERROR 2: Calcular base con fÃ³rmula

Usar base = total / (1 + ivaRate/100) es incorrecto si el total ya tiene aplicada una retenciÃ³n (IRPF). Eso distorsiona completamente la base y el IVA.

âŒ ERROR 3: No distinguir total bruto vs neto

Si totalAmount ya incluye el IRPF (neto), pero se trata como si fuera bruto, se rompe el cÃ¡lculo.

âœ… Â¿CuÃ¡l es la soluciÃ³n?

En el backend, la lÃ³gica debe ser:

if (additionalTaxes contiene IVA con value explÃ­cito) {
   ivaSoportado += ivaAmount;
   baseGasto += (totalAmount - ivaAmount);
} else {
   // Ãºltima opciÃ³n: estimaciÃ³n
   baseGasto += totalAmount / (1 + ivaRate / 100);
   ivaSoportado += totalAmount - baseGasto;
}

Y si hay IRPF:

if (additionalTaxes contiene IRPF con value) {
   netExpenses += (totalAmount - irpfAmount);
} else {
   netExpenses += totalAmount;
}

ğŸ§ª Â¿Quieres que hagamos un ejemplo real con 3 facturas?

Por ejemplo:

Base	IVA 21%	IRPF 15%	Total esperado
100â‚¬	21â‚¬	-15â‚¬	106â‚¬
500â‚¬	105â‚¬	-75â‚¬	530â‚¬
1000â‚¬	210â‚¬	-150â‚¬	1060â‚¬

Puedo ayudarte a simular cÃ³mo se deben guardar y cÃ³mo procesarlas para que todos los cÃ¡lculos cuadren.

Â¿Quieres que lo prepare asÃ­ en formato JSON ejemplo o directamente en cÃ³digo del backend?